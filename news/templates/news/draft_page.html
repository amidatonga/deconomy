{% extends 'news/base.html' %}
{% load filters %}
{% load social_share %}

{% block content %}
      <div class="post-page">
        <div class="post-author-date">
          <div class="post-author">
            <p>By {{ object.author.profile.fullname }}</p>
          </div>
          <div class="post-date">
            {% if not object.published_date %}
              <p>Draft created: <b>{{ object.created_date|time_ago:"ago" }}</b></p>
            {% else %}
              <p><b>{{ object.published_date|time_ago:"ago" }}</b></p>
            {% endif %}
          </div>

        </div>
        <div class="post-title">
          <h1>{{ object.title }}</h1>
        </div>
       <!-- <img src="{{ object.author.profile.img.url }}" alt="{{ object.author }}" class="mr-2 rounded avatar-img" style="width: 64px; height: 64px;"> -->
       <p>{{ object.text|safe }}</p>
       <p>{{ object.created_date|time_ago:"ago" }}</p>
        {% if object.category %}
            <p>Category: <a href="{% url 'category_news' slug=object.category.slug %}">{{ object.category }}</a></p>
        {% endif %}
        <p>Views: {{ post.views }}</p>
        {% for post_tag in post.tags.all %}
          <a href="{% url 'tag_news' post_tag.slug %}" class="badge badge-pill badge-light">{{ post_tag.name }}</a>
        {% endfor %}

        {% if object.author == user or user.profile.moderator %}
        <br>
        <a class="button" href="{% url 'edit_post' post.slug %}">Edit</a>
        <a href="{% url 'delete_post' post.slug %}">Delete</a>
        {% endif %}
        <br><br>
        {% if user.profile.moderator %}
        <a class="button" href="{% url 'publish_post' post.slug %}">Publish</a>
        {% endif %}
        <br>
        <p>All articles by: <a href="{% url 'user_news' object.author %}">{{ object.author }}</a></p>



       <br><br>
      </div>
{% endblock content %}

{% block side-bar %}
    {% include 'news/includes/profile_sidebar.html' %}
{% endblock side-bar %}


{% block extra_js %}
<script type="text/javascript">

    var csrftoken = getCookie('csrftoken');

    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    var processing;

    $(document).ready(function(){

        $(document).scroll(function(e){

            if (processing)
                return false;

            var url = "{% url 'api_news_more' %}";
            var current_news = $('div[id^="post-"]').last().attr('id').split('-')[1];
            var data = {
                'category': '{{ object.category.slug }}',
                'current_news': current_news,
            };

            if ($(window).scrollTop() >= ($(document).height() - $(window).height()) * 0.7){
                processing = true;
                $.post(
                    url, data, function (resp) {
                        $('#load_more').before(resp.html);
                        if (!resp.one_more) {
                            $('#load_more').hide();
                        }
                        processing = false;
                        $(window).scrollTop($(window).scrollTop()+1);
                    }
                )
            }
        });
    });

</script>
<script type="text/javascript">
  $(".side-bar").stick_in_parent();
</script>
{% endblock %}
